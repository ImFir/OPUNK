function savecookie(e,s){const n=432e6;admin.auth().createSessionCookie(e,{expiresIn:n}).then(t=>{const o={maxAge:n,httpOnly:!0,secure:!0};s.cookie("__session",t,o),admin.auth().verifyIdToken(e).then(function(e){s.redirect("/")})},e=>{console.log(e),s.status(401).send("UnAuthorised Request")})}function checkCookie(e,s,n){const t=e.cookies.__session||"";admin.auth().verifySessionCookie(t,!0).then(s=>{e.decodedClaims=s,n()}).catch(e=>{s.redirect("/login")})}function sessionLogout(e,s,n){const t=e.cookies.__session||"";s.clearCookie(n),admin.auth().verifySessionCookie(t,!0).then(e=>admin.auth().revokeRefreshTokens(e.sub)).then(()=>fs.unlinkSync(SESSION_FILE_PATH,function(e){if(e)return console.log(e);console.log("Session file deleted!")})).then(()=>{s.redirect("/login")}).catch(e=>{s.redirect("/login")})}const{Client:Client,MessageMedia:MessageMedia}=require("whatsapp-web.js"),express=require("express"),app=express(),{body:body,validationResult:validationResult}=require("express-validator"),fileUpload=require("express-fileupload"),fs=require("fs"),http=require("http"),server=http.createServer(app),socketIO=require("socket.io"),io=socketIO(server),cookieParser=require("cookie-parser"),qrcode=require("qrcode"),{phoneNumberFormatter:phoneNumberFormatter}=require("./helpers/formatter"),{assetSource:assetSource}=require("./helpers/assets"),axios=require("axios"),mime=require("mime-types"),CSVToJSON=require("csvtojson"),admin=require("firebase-admin"),port=process.env.PORT||8e3,key="-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDNThowatHMH3S3\nXS2FVdMSK1FfRcsJFs+cploycG+Lzum89rk0ME/XeE9IUEmJ7Uh9l05HozQLnNPb\nD2oxyGkbq74b54cU2nHnBE8FdmZEe5DJb9TPcKLQCLWpSR7V+U0Sy95lN+TemKKd\nbwMES0niiZ9NdlvsxE8Wyn7xKPFBok+epEkUBEvPh3cuIXu0b0gouAFgb6JUIrl2\nPeiJ17jU3exKHTfIG9nAsBr6/UUoneY8tzu+Uwmf3nDzFeBCQol8BO+q3MgHAc2O\nCXtjya7+Ppuh23lVyKMh3u4qvwEI/UIlaGxADwPAtV/yd1Ogykewd8E/1d5UuLVO\np42xMI4BAgMBAAECggEAFuNkg2NVR7F2Ef80VPoa0Zq8s/y+7vYjvS4ak3xPeJcK\nc0Ok+s7Wsonkz4YL53GUXv61qReRH35OFsz4JNwCmSV4yKRI6KfrLOXLvYB+qZcx\nBBQQoJ5zuEeloQgthONfQVTd0rZRhgjJkE2mWMiKpdPRS7yB8Q/NqsJ2i9eUVfcE\nUP5PgmdbFQX8ijo7AIOR9VIvVdylzER5oIg+uaMy8ske05vv7xO4jfHMguwjr0HX\n7E/OMu3V9pU91t/lDLP4jlWrOUG2Vq//Xre3UK7vRX8943/9gurCPJhP4AON0lkh\nIr57Sfrvggz1u8VrwDg0r1uGPs0Gj4OOCHoxS9k41QKBgQDrM9dXW8t0JsZQ152i\nSghmtgf5ZMRg3zxopg1ljkuQbQ7Yn2ek21rG7hCpcnBsoOXk9nMu76xh1JTCBri1\nuGquKhUlPBhMTaLAj1r1JGg8cn6ocIN1PFJaze7KZTlKU2qnwMpcLEkaZLQoQbLO\nzJVm+vtzQ7ToH8xBhSCzcMx0vwKBgQDfdX0TJPAz/qFlreh4fGE2F5hhffnqnKKO\nQhRX+7mv1AoGRLXA4fOBmgAk8yvxuGc5Y21RlaqJab8LziKnu2Lm9CS8s0rnUuJ/\n//aksYCt/YwXfVWBKlRKSg+6Rao6qomR1iSAuF/LHzt4WF9wZBYPLE3YqnsCN7ME\nclsTFPXtPwKBgGjuSeYJZ+0710H9z6+1g6X/E/OphwsIzPSLEHL8Vq3qWbM++ohL\n7GXPk9Nk4M81wRqy8JRCDQ/gPTWKtiEsUzu8Po7MDrML984cpqGzSmWdVvBiseM9\ntCgas6vMGREVwgFxO1Z/02VZBB7poJIuJ4E3+7JixHTCqueYMwybCDwVAoGBAJwE\nDrCYILFcvdkdI+tDhCfdL4IaD6yTchd64XNQiKPPmrQnsvKZj4dUO3eQ5ISfKEr0\nNXY51didIUsfwCh196ainSe20rxRrVyLHOx+FgbkuLQJyPIm2LUJopN+Yk0Vlnlh\nFxlcIV3TT5VFtlTlPFWZrDxzQvEYbH/VS+s1vkLHAoGADcb0/8hO76pjG+GTH594\nySoEQZ5/vXgyEMWyXl3y+yfKzLvn66QbYgp7RAh4Ph7uhdLyg1vRGSbHCuQb2AjP\n3mEZ2VvJVj+1P3PrRrzdW6qGrICJtJtTIlwjteimrE3g6KBHhE8BgqFtg7qqsScI\nuK704XiWNgnnqCh2lJ2Zhsk=\n-----END PRIVATE KEY-----\n";let sessionCfg;admin.initializeApp({credential:admin.credential.cert({private_key:key.replace(/\\n/g,"\n"),client_email:"firebase-adminsdk-qimex@opunk-9c443.iam.gserviceaccount.com",project_id:"opunk-9c443"})});const SESSION_FILE_PATH=`${__dirname}/whatsapp-session.json`;fs.existsSync(SESSION_FILE_PATH)&&(sessionCfg=require(SESSION_FILE_PATH));const client=new Client({restartOnAuthFail:!0,puppeteer:{headless:!0,args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--no-first-run","--no-zygote","--single-process","--disable-gpu"]},session:sessionCfg});client.initialize();const checkRegisteredNumber=async function(e){const s=await client.isRegisteredUser(e);return s};client.on("message",e=>{"!ping"==e.body?e.reply("pong"):"good morning"==e.body?e.reply("selamat pagi"):"!groups"==e.body&&client.getChats().then(s=>{const n=s.filter(e=>e.isGroup);if(0==n.length)e.reply("You have no group yet.");else{let s="*YOUR GROUPS*\n\n";n.forEach((e,n)=>{s+=`ID: ${e.id._serialized}\nName: ${e.name}\nContact Participant: ${e.participants.map(e=>e.id._serialized)}\n\n`}),s+="_You can use the group id to send a message to the group._",e.reply(s)}}),e.hasMedia&&e.downloadMedia().then(e=>{if(console.log(e),e){const s="./downloaded-media/";fs.existsSync(s)||fs.mkdirSync(s);const n=mime.extension(e.mimetype),t=(new Date).getTime(),o=s+t+"."+n;try{fs.writeFileSync(o,e.data,{encoding:"base64"}),console.log("File downloaded successfully!",o)}catch(e){console.log("Failed to save the file:",e)}}})}),app.use(express.json()),app.use(express.static(__dirname+"views/js")),app.use(express.urlencoded({extended:!0})),app.use(fileUpload({debug:!0})),app.use(cookieParser()),io.on("connection",e=>{e.emit("message","Whatsapp is connected"),client.on("qr",s=>{console.log("QR RECEIVED",s),qrcode.toDataURL(s,(s,n)=>{e.emit("qr",n),e.emit("message","QR Code received, scan please!")})}),client.on("ready",()=>{e.emit("ready","Whatsapp is ready!"),e.emit("message","Whatsapp is ready!")}),client.on("authenticated",s=>{e.emit("authenticated","Whatsapp is authenticated!"),e.emit("message","Whatsapp is authenticated!"),console.log("AUTHENTICATED",s),sessionCfg=s,fs.writeFile(SESSION_FILE_PATH,JSON.stringify(s),function(e){e&&console.error(e)})}),client.on("auth_failure",function(s){e.emit("message","Auth failure, restarting...")}),client.on("disconnected",s=>{e.emit("message","Whatsapp is disconnected!"),fs.unlinkSync(SESSION_FILE_PATH,function(e){if(e)return console.log(e);console.log("Session file deleted!")}),client.destroy(),client.initialize()})}),app.get("/",checkCookie,(e,s)=>{s.sendFile("views/index.min.html",{root:__dirname}),console.log("UID of Signed in User is"+e.decodedClaims.uid)}),app.get("/login",(e,s)=>{s.sendFile("views/login.min.html",{root:__dirname})}),app.get("/hal/:source",(e,s)=>{s.sendFile(`views/${e.params.source}.min.html`,{root:__dirname})}),app.get("/modul/:source",(e,s)=>{s.sendFile(`views/app_modules/${e.params.source}`,{root:__dirname})}),app.get("/js/:source",(e,s)=>{s.sendFile(`views/js/${e.params.source}.js`,{root:__dirname})}),app.get("/css/:source",(e,s)=>{s.sendFile(`views/css/${e.params.source}.css`,{root:__dirname})}),app.get("/logout",(e,s)=>{sessionLogout(e,s,"__session")}),app.get("/savecookie",(e,s)=>{const n=e.query.idToken;console.log(n,s),savecookie(n,s)}),app.get("/download",function(e,s){const n=`${__dirname}/uploads/template_msg.csv`;s.download(n)}),app.get("/js-index",function(e,s){const n=`${__dirname}/views/js/index.min.js`;s.download(n)}),app.get("/js-auth",function(e,s){const n=`${__dirname}/views/js/auth.min.js`;s.download(n)}),app.get("/assets/:source",function(e,s){const n=`${__dirname+assetSource(e.params.source)}`;s.download(n)}),app.post("/uploadfile",function(e,s,n){const t=e.files.file,o=e.body.type,i="./uploads/"+o+"/";fs.existsSync(i)||fs.mkdirSync(i),t.mv(i+t.name,function(e,n){if(e)throw e;CSVToJSON().fromFile(i+t.name).then(e=>s.status(200).json({status:!0,response:e})).catch(e=>s.status(500).json({status:!1,response:e}))})}),app.get("/group-getcontact",function(e,s){client.getChats().then(e=>{const n=e.filter(e=>e.isGroup);if(0==n.length)return s.status(422).json({status:!1,response:"You have no group yet."});{let e=[],t=[];return n.forEach((e,s)=>{t.push({id_group:`${e.id._serialized}`,name_group:`${e.name}`,contacts:`${e.participants.map(e=>e.id._serialized)}`})}),e.push({yourGroups:t}),s.status(200).json({status:!0,response:e})}})}),app.post("/send-message",[body("number").notEmpty(),body("message").notEmpty()],async(e,s)=>{const n=validationResult(e).formatWith(({msg:e})=>e);if(!n.isEmpty())return s.status(422).json({status:!1,message:n.mapped(),response:n.mapped()});const t=phoneNumberFormatter(e.body.number),o=e.body.message,i=e.body.msgtype,a=await checkRegisteredNumber(t);if(!a)return s.status(422).json({status:!1,message:"The number is not registered",response:"The number is not registered"});if("normal"===i&&client.sendMessage(t,o).then(e=>{s.status(200).json({status:!0,response:e})}).catch(e=>{s.status(500).json({status:!1,response:e})}),"fileupload"===i){const n=e.files.file,i=new MessageMedia(n.mimetype,n.data.toString("base64"),n.name);client.sendMessage(t,i,{caption:o}).then(e=>{s.status(200).json({status:!0,response:e})}).catch(e=>{s.status(500).json({status:!1,response:e})})}if("filelink"===i){const n=e.body.file;let i;const a=await axios.get(n,{responseType:"arraybuffer"}).then(e=>(i=e.headers["content-type"],e.data.toString("base64"))),r=null!=n.name?n.name:"file attachment",c=new MessageMedia(i,a,r);client.sendMessage(t,c,{caption:o}).then(e=>{s.status(200).json({status:!0,response:e})}).catch(e=>{s.status(500).json({status:!1,response:e})})}}),server.listen(port,function(){console.log("App running on *: "+port)});