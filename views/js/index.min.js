function select2Numbers(){$("select[name='numbers']").select2({tags:!0,tokenSeparators:[";"," "],multiple:!0,width:"100%",minimumInputLength:8,newTag:!0,cache:!0})}function modalOptionKirim(){$(".modalOptModemudah-media").on("shown.bs.modal",function(){sertakanMedia()}),$(".modalOptModemudah-durasi").on("shown.bs.modal",function(){simpanOptMessage1("durasi")}),$(".modalOptModemudah-uploadcsv").on("shown.bs.modal",function(){simpanOptMessage1("uploadcsv")})}function clearMessage1(){$("a.clear-message").on("click",function(e){e.preventDefault(),$("select[name='numbers']").text(null),$("textarea[name='message']").val("")})}function sertakanMedia(e=null){$("input[name='sertakanmedia']").on("change",function(){$("input[name='sertakanmedia']").each(function(){1==$(this).prop("checked")&&($(".sertakanmedia").removeAttr("disabled"),$(".sertakanmedia").removeClass("d-none"),$(".mediaattach").removeClass("d-none"),$("select[name='sumber-media']").val("attach"),sumberMedia()),0==$(this).prop("checked")&&($(".sertakanmedia").addClass("d-none"),$(".sertakanmedia").attr("disabled","disabled"),$(".mediaattach").addClass("d-none"),$(".mediaurl").addClass("d-none")),simpanOptMessage1("sourcemedia")})})}function sumberMedia(e=null){$("select[name='sumber-media']").on("change",function(){const e=$("select[name='sumber-media'] :selected").val();"attach"===e&&($(".mediaattach").removeClass("d-none"),$(".mediaurl").addClass("d-none")),"link"===e&&($(".mediaurl").removeClass("d-none"),$(".mediaattach").addClass("d-none"))})}function simpanOptMessage1(e=null){"sourcemedia"===e&&$("div.modalOptModemudah-media").on("click","button#simpan-sourcemedia",function(){const e=$("select[name='sumber-media'] :selected").val(),t=$("input[name='sourcemediaurl']").val(),a=$("input[name='sourcemediaattach']").val();if("attach"===e){if(0==a.length)return alert("sumber media file tidak boleh kosoong!"),!1;$(".smedia").html(a),$(".ssmedia").html(e),$("div.modalOptModemudah-media").modal("hide")}if("link"===e){if(0==t.length)return alert("sumber media Lnk tidak boleh kosoong!"),!1;$(".smedia").html(t),$(".ssmedia").html(e),$("div.modalOptModemudah-media").modal("hide")}}),"durasi"===e&&$("#simpan-durasi").on("click",function(){const e=$("input[name='durasi-kirim']").val();if(0==e.length)return alert("Durasi kirim harus diisi!"),!1;$(".sdurasi").html(e),$("div.modalOptModemudah-durasi").modal("hide")}),"uploadcsv"===e&&$("div.modal").on("click","button#upload-csv",function(e){e.preventDefault();var t=new FormData;t.append("type","csv"),t.append("file",$("input[type=file]")[0].files[0]),$.ajax({url:uploadcsv,type:"post",data:t,contentType:!1,processData:!1,mimeType:"multipart/form-data",success:function(e){const t=JSON.parse(e);let a="<table class='table table-striped m-0' id='tabelwa'><thead><tr><th>No.</th><th>contact</th><th>name</th><th>message</th><th>Sumber Media (link)</th><th>Tipe </th><th>Sumber Media (Upload)</th></tr></thead><tbody>";for(let e=0;e<t.response.length;e++)a+="<tr>",a+="<td class='m-0'>"+(e+1)+"</td>",a+="<td class='m-0'>"+t.response[e].contact+"</td>",a+="<td class='m-0'>"+t.response[e].name+"</td>",a+="<td class='m-0'>"+t.response[e].message+"</td>",a+="<td class='m-0'>"+t.response[e].linksource+"</td>",a+='<td class="tipemedia m-0"><select id="tipemedia_'+e+'" class=""><option value="link">Link</option><option value="upload">Upload</option></select></td>',a+="<td class='m-0'><input type='file' name='mediaupload_"+e+"' id=''></td>",a+="</tr>";a+="</tbody></table>",$("#list-contact").html(a),$("div.modalOptModemudah-uploadcsv").modal("hide")}})})}function simpleBc(e,t){$.ajax({url:urlsendMessage,type:"post",data:{number:e,message:t,msgtype:"normal"},success:function(e){const a=JSON.stringify(e),s=JSON.parse(a);var n=!0===s.status?iconS:iconG,l=s.response.to.replace("@c.us","").substr(2);logMsg("0"+l,t+" - "+n,"")}})}function withMediaLinkBC(e,t,a){$.ajax({url:urlsendMessage,type:"post",data:{number:e,message:t,file:a,msgtype:"filelink"},success:function(s){const n=JSON.stringify(s),l=JSON.parse(n);var o=!0===l.status?iconS:iconG;const d=l.response.type;"image"!==d&&simpleBc(e,t),logMsg(e,t+'<br><img src="'+a+'" style="width: 100px;" /><br> - '+o,d)}})}function withMediaUploadBC(e,t,a){var s=new FormData,n=a[0].files[0];s.append("number",e),s.append("message",t),s.append("file",n),s.append("msgtype","fileupload"),$.ajax({url:urlsendMessage,type:"post",data:s,contentType:!1,processData:!1,mimeType:"multipart/form-data",success:function(a){const s=JSON.parse(a),n=!0===s.status?iconS:iconG,l=s.response.type;"image"!==l&&simpleBc(e,t),logMsg(e,t+" - "+n,l)}})}function logMsg(e=null,t,s=null){$(".toast").addClass("show"),"document"===s&&"image"===s||(s="text");let n="";n+='<div class="alert alert-left alert-success alert-dismissible fade show mb-1" role="alert">',n+='<span><i class="fas fa-comment"></i></span>&nbsp;',n+="<span>"+e+"</span><br>",n+="<em style='font-size: 0.5em;'>"+a+"</em><br>",n+="<span>"+t+"</span><br>",n+="<code>"+s+"</code>",n+='<button type="button"class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>',$(".toast").toast("show"),$(".toast-body").prepend("("+a+")<br> Tipe: "+s+" - HP: "+e+" - Status: "+t+"<hr>"),$("#isi-history-send").prepend(n)}function sendModeMudah(){$("#send-mudah").on("click",function(e){e.preventDefault();const t=$("select[name='numbers']"),a=$("textarea[name='message']"),s=0==$(".sdurasi").html().length?10:$(".sdurasi").html(),n=$(".ssmedia").html(),l=$(".smedia").html();if($(this).attr("disabled","disabled"),$(".toast-body").html(""),0==parseInt(t.val().length))return alert("No Whatsapp tujuan tidak boleh kosong"),t.focus(),!1;if(0==a.val().length)return alert("Pesan tidak boleh kosong"),a.focus(),!1;if(n.length>0){if(0===l.length)return alert("Sumber media tidak boleh kosong!"),!1;procSendMudah(t.val(),a.val(),n,l,s)}0==n.length&&procSendMudah(t.val(),a.val(),null,null,s)})}function procSendMudah(e,t,a=null,s=null,n=parseInt(10)){let l=e.toString().split(",");$(".pesanke").html(0),$(".pesandari").html(l.length);var o=setInterval(()=>{let e=parseInt($(".pesanke").html()),n=parseInt($(".pesandari").html());if(l[e].length>0){if(parseInt(e)===parseInt(n))return $("#send-mudah").html('<i class="fas fa-paper-plane"></i> Send'),$("#send-mudah").removeAttr("disabled"),clearInterval(o),!1;if(null===a&&simpleBc(l[e],t),null!==a){if("attach"===a){const a=$("input[name='sourcemediaattach']");withMediaUploadBC(l[e],t,a)}"link"===a&&withMediaLinkBC(l[e],t,s)}e++,$("#send-mudah").html(e+" of "+n),$(".pesanke").html(e),parseInt(e)===parseInt(n)&&($("#send-mudah").html('<i class="fas fa-paper-plane"></i> Send'),$("#send-mudah").removeAttr("disabled"),clearInterval(o))}},1e3*parseInt(n))}function sendModeSusah(){$("select[name='opttemplate']").on("change",function(){var e=$("#message"),t=e.val();$("select[name='opttemplate'] option:selected").each(function(){t+=$(this).val()+" "}),e.val(t)}).trigger("change"),$("#send-susah").on("click",function(e){e.preventDefault();const t=$("textarea[name='message']"),a=0==$(".sdurasi").html().length?10:$(".sdurasi").html(),s=$("table tbody tr").length;let n=!1;if($(this).attr("disabled","disabled"),$(".toast-body").html(""),0==t.val().trim().length)return alert("Pesan tidak boleh kosong"),t.focus(),$(this).removeAttr("disabled"),!1;if(s<=0)return alert("File .csv belum di upload!"),$(this).removeAttr("disabled"),!1;if(s>0){if($("input[name='sertakanmedia']").each(function(){1==$(this).prop("checked")&&(n=!0)}),0==n)return procSendSusah(parseInt(s),t.val(),a),!1;procSendSusah(parseInt(s),t.val(),a,!0)}})}function procSendSusah(e,t,a=parseInt(10),s=!1){$(".pesanke").html(0),$(".pesandari").html(e);var n=setInterval(()=>{let e=parseInt($(".pesanke").html()),a=parseInt($(".pesandari").html());if(e<a){if(e===a)return $("#send-susah").html('<i class="fas fa-paper-plane"></i> Send'),$("#send-susah").removeAttr("disabled"),clearInterval(n),!1;const l=$("table tbody tr:eq("+e+") td:eq(1)").html(),o=$("table tbody tr:eq("+e+") td:eq(2)").html(),d=$("table tbody tr:eq("+e+") td:eq(3)").html(),i=$("table tbody tr:eq("+e+") td:eq(4)").html(),r=$("table tbody tr:eq("+e+") td:eq(5) select option:selected").val(),c=$("table tbody tr:eq("+e+") td:eq(6) input[type='file']").val(),m=t.replace("{{ hp }}",l).replace("{{ nama }}",o).replace("{{ pesan }}",d).replace("{{ link }}",i);if(l.trim().length<1&&logMsg("-",iconG+" (No. HP Kosong) ","-"),l.trim().length>0&&(!1===s&&simpleBc(l,m),!0===s)){if("upload"===r&&(c.trim().length<1&&logMsg("-",iconG+" (file sumber kosong) ","-"),c.trim().length>0)){const t=$("table tbody tr:eq("+e+") td:eq(6) input[type='file']");withMediaUploadBC(l,m,t)}"link"===r&&(i.trim().length<1&&logMsg("-",iconG+" (file sumber kosong) ","-"),i.trim().length>0&&withMediaLinkBC(l,m,i))}e++,$("#send-susah").html(e+" of "+a),$(".pesanke").html(e),parseInt(e)===parseInt(a)&&($("#send-susah").html('<i class="fas fa-paper-plane"></i> Send'),$("#send-susah").removeAttr("disabled"),clearInterval(n))}},1e3*parseInt(a))}function grabContactGroup(){$("button#grab-allcontact").on("click",function(e){$(this).html("Please wait.."),procGetContactGroups()})}async function procGetContactGroups(){return $.ajax({url:urlgetContactGroups,type:"get"}).then(e=>{const t=JSON.stringify(e),a=JSON.parse(t);if(!0===a.status){const e=a.response[0].yourGroups;if(e.length>0){let t='<table class="table table-sm table-striped" id="tblkontakgroup" style="width:100%"><thead><tr><th>No.</th><th>ID Grup</th><th>Nama Group</th><th>Jml Kontak</th><th>No. Kontak</th></tr></thead><tbody>',s=0;for(let a=0;a<e.length;a++){const n=e[a].contacts.replace(/@c.us/gi,"").replace(/,/gi,";"),l=n.split(";"),o=e[a].id_group,d=e[a].name_group,i=parseInt(a+1);t+="<tr>",t+="<td>"+i+"</td>",t+="<td>"+o+"</td>",t+="<td>"+d+"</td>",t+="<td>("+l.length+" kontak)</td>",t+="<td>"+n+"</td>",t+="</tr>",s+=parseInt(l.length)}t+="</tbody></table>",$(".result-grabcontact").html(t),$("button#grab-allcontact").html("Grab All"),$(".jmlgrup").html(e.length+" group"),$(".jmlkontak").html(s+" kontak"),$("table").DataTable({responsive:!0}),console.log(a.response[0].yourGroups)}}})}function showQR(e=!0){1==e&&($("div#modulqrcode").removeClass("d-none"),$("div#modulqrcode").show(),$("div.iq-sidebar").addClass("d-none"),$("div.iq-sidebar").hide(),$("#msgscan").html("QR Code received, scan please!")),0==e&&($("div#modulqrcode").addClass("d-none"),$("div#modulqrcode").hide(),$("div.iq-sidebar").removeClass("d-none"),$("div.iq-sidebar").show())}const co=$(".container"),doc=$(document),sc=$("div.sub-container"),ho=$("#home"),qr=$("#qrcode"),at=$("a.tampilmodul"),as="a.tampilsubmodul",host="http://localhost:8000/",urlsendMessage=host+"send-message",hmod=host+"assets/mod",uploadcsv=host+"uploadfile",urlgetContactGroups=host+"group-getcontact",socket=io(),iconS="<i class='fas fa-check-circle text-success'></i> ",iconG="<i class='fas fa-times-circle text-danger'></i> ",d=Date(Date.now()),a=d.toString(),url=window.location.href;$(document).ready(function(){socket.on("message",function(e){logMsg(null,e,null),"QR Code received, scan please!"===e&&showQR(!0),"Whatsapp is connected"===e&&showQR(!1)}),socket.on("qr",function(e){showQR(!0),$("#qrcode").attr("src",e)}),socket.on("ready",function(e){showQR(!1)}),socket.on("authenticated",function(e){showQR(!1)}),url.indexOf("broadcast-mudah")>-1&&(select2Numbers(),modalOptionKirim(),clearMessage1(),sendModeMudah()),url.indexOf("broadcast-susah")>-1&&(select2Numbers(),modalOptionKirim(),clearMessage1(),sendModeSusah()),url.indexOf("tools-grabcontact")>-1&&grabContactGroup()});